# カーネルパニック（Kernel Panic）とは何か

	•	OSの中核であるカーネルが回復不能な致命的エラーを検出し、安全のためにシステムを停止させる状態
	•	システム全体の致命的な停止

## 全体像

= カーネルパニックとは

「OSの整合性が保証できなくなったため、安全停止した状態」

よくある原因：

	•	ハードウェア
	•	カーネルモジュール
	•	ルートFS障害
	•	カーネルバグ


- 設計思想
  - **Fail-Fast**な設計
    - カーネルは「信頼できる最後の砦」
    - メモリ破壊や整合性崩壊を検知したら継続せず停止する

- 典型的なメッセージ

```
Kernel panic - not syncing: Fatal exception
```

## 発生している内部状態（技術的観点）
- カーネルパニック時は通常以下のいずれかが発生
  - カーネル空間で不正メモリアクセス（NULL参照など）
  - 割り込みコンテキストでの致命的例外
  - スタック破壊
  - スケジューラが復旧不能状態
  - ルートファイルシステムがマウント不能
  - OOM Killerすら機能しないメモリ破壊

- Linuxでは `panic()` 関数が呼び出され、下記が実行される
- ログ出力
- sync試行
- CPU停止 or 自動再起動

# よくある原因

## ハードウェア障害
	•	メモリエラー（ECC未検出）
	•	ディスク故障
	•	CPU過熱
	•	電源不安定

### 兆候
	•	不規則発生
	•	ログにMCE（Machine Check Exception）

### 確認方法

```
dmesg -T | grep -i error
journalctl -k -b -1
```

## 不正なカーネルモジュール
	•	自作ドライバ
	•	NVIDIAドライバ
	•	DKMSビルド失敗
	•	互換性のないモジュール

### ログ

```
Unable to handle kernel NULL pointer dereference
```

### 対処
	•	セーフモード（rescue.target）起動
	•	該当モジュール無効化
	•	カーネルロールバック

## ルートファイルシステム障害

### ログ

```
VFS: Unable to mount root fs
```

### 原因
	•	initramfs破損
	•	UUID変更
	•	fstab誤記載
	•	LVM未認識

## メモリ不足（OOMとは別）

通常のOOMはユーザプロセスがkillされるが、
**カーネル領域が破壊された場合**はpanicになる。

## カーネルバグ

### 特徴
	•	新バージョン導入直後
	•	特定syscallで再現

# 対処方法（体系的整理）

インシデント対応フロー型で整理

## フェーズ1：即時対応（サービス復旧優先）

	1.	自動再起動設定確認

```
cat /proc/sys/kernel/panic
```

	2.	手動再起動
	3.	別カーネルで起動（GRUB）

## フェーズ2：原因特定

	1. 前回ブートログ確認

```
journalctl -k -b -1
```

	2. kdump設定があれば解析

```
/var/crash/
```

	3. ハードウェア確認

```
memtest
smartctl
```

## フェーズ3：恒久対策

```
原因 → 恒久対策
ドライバ → バージョン固定
カーネル → LTS固定
メモリ → ECC導入
ディスク → RAID/監視
設定誤り → IaC化
```

# 予防策

## 1. カーネル更新を段階展開
	•	Canaryノード
	•	ロールアウト管理

## 2. kdump有効化

```
systemctl enable kdump
```

## 3. panic時自動再起動

```
sysctl -w kernel.panic=10
```

## 4. 監視
	•	node_exporter
	•	ハードウェアログ監視
	•	ECCエラー監視
